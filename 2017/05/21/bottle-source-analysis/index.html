<html>
    <!DOCTYPE html>
<html lang="zh">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta http-equiv="X-UA-Compatible" content="ie=edge">

	

	<title>Bottle 源码分析 | 正小歪的博客</title>
	<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1">
	<link rel="shortcut icon" href="/favicon.ico">	
	<link rel="stylesheet" href="/css/bootstrap.min.css">
	<link rel="stylesheet" href="/css/style.css">
    <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<link rel="stylesheet" href="/css/prism.css" type="text/css"></head>

    <body>
        <div class="root">
            <div class='topnavs container fixed-690'>
    <nav class="navbar navbar-expand-lg navbar-light">
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent"
            aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarSupportedContent">
            <ul class="navbar-nav mr-auto">
                
                    <li class="nav-item">
                        <a class="nav-link" href="/">
                            首页
                        </a>
                    </li>
                    
                    <li class="nav-item">
                        <a class="nav-link" href="/categories">
                            分类
                        </a>
                    </li>
                    
                    <li class="nav-item">
                        <a class="nav-link" href="/archives">
                            归档
                        </a>
                    </li>
                    
            </ul>
        </div>
    </nav>
</div>
                <section class="container mainbody fixed-690">
                    <div class="post">
    <div class="post-title">
        <h1>
            Bottle 源码分析 
        </h1>

        
        <div class="post-title-views">
            <span id="busuanzi_container_page_pv">
                本文总阅读量 <span id="busuanzi_value_page_pv"></span> 次
            </span>
        </div>
        
    </div>
    <div class="post-content markdown">
        <p>Bottle 是一个快速，简单和轻量级的 WSGI 微型 Web 框架的 Python。它作为单个文件模块分发，除了 Python 标准库之外没有依赖关系。</p>
<p>选择源码分析的版本是 Release 于 2009 年 7 月 11 日的 0.4.10 （这是我能找到的最早的发布版本了）。</p>
<a id="more"></a>
<p>为什么要分析 Bottle 这个比较冷门的框架？</p>
<ul>
<li>Bottle 从发布至今一直贯彻的微型 Web 框架的理念。</li>
<li>Bottle 一直坚持单文件发布，也就是只有一个 bottle.py 文件。</li>
<li>除了 Python 标准库之外没有依赖关系。</li>
<li>与 Flask、Django 都遵循 PEP-3333 的 WSGI 协议。</li>
<li>0.4.10 版本代码量小，加上大量注释也只有不到 1000 行的代码。</li>
</ul>
<p>所以，抛开框架的高级功能，单单从一个 Web 框架怎么处理请求的角度来看，Bottle 是最佳的选择。</p>
<blockquote>
<p>Flask 从第一版开始就是依赖于 werkzeug 实现，更多的实现细节需要从 werkzeug 中查找。</p>
<p>Django 是个重型框架，不适合整体代码阅读，各个组件看看就可以。</p>
<p>Tornado 是个异类，和 WSGI 没有什么关系。</p>
</blockquote>
<p>在阅读之前最好从 Github 上下载一份 <a href="https://github.com/bottlepy/bottle/archive/0.4.10.zip" target="_blank" rel="noopener">0.4.10 版本的 Bottle</a> 的源码，边看边阅读本文。</p>
<p>阅读本文你需要有如下技能：</p>
<ul>
<li>熟悉 Python 的语法</li>
<li>熟悉 HTTP 协议</li>
<li>至少使用过一种 WSGI 的框架</li>
<li>了解 CGI</li>
<li>看得懂中文</li>
</ul>
<h2 id="流程结构分析"><a href="#流程结构分析" class="headerlink" title="流程结构分析"></a>流程结构分析</h2><p>代码虽然不多，但是毫无目的的看难免思绪混乱，会看的心烦意乱，甚至会有产生「写的这是什么鬼？」的想法。</p>
<p>一个 Web 框架最核心也是最基本的功能就是处理 <strong>请求</strong> 和 <strong>响应</strong>。</p>
<p>但是在这之前，需要先创建一个 Server，才能开始处理啊！</p>
<p>所以大体的流程如下：</p>
<ol>
<li>怎么创建一个 WSGI 的 Server 。</li>
<li>怎么处理到来的请求。</li>
<li>怎么处理响应。</li>
</ol>
<h2 id="创建-WSGI-Server"><a href="#创建-WSGI-Server" class="headerlink" title="创建 WSGI Server"></a>创建 WSGI Server</h2><p>在 Bottle 中关于创建一个<strong>标准</strong>的 WSGI Server 涉及的类或者方法只有 3 个。</p>
<blockquote>
<p>注意，这里只关心一个标准的 WSGI，和核心功能。包括注释、错误处理、参数处理，会统统删除。</p>
</blockquote>
<p>从文档中可以看到 Bottle 是通过一个 run 方法启动的。</p>
<pre class=" language-python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">run</span><span class="token punctuation">(</span>server<span class="token operator">=</span>WSGIRefServer<span class="token punctuation">,</span> host<span class="token operator">=</span><span class="token string">'127.0.0.1'</span><span class="token punctuation">,</span> port<span class="token operator">=</span><span class="token number">8080</span><span class="token punctuation">,</span> optinmize <span class="token operator">=</span> <span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token operator">**</span>kargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
    server <span class="token operator">=</span> server<span class="token punctuation">(</span>host<span class="token operator">=</span>host<span class="token punctuation">,</span> port<span class="token operator">=</span>port<span class="token punctuation">,</span> <span class="token operator">**</span>kargs<span class="token punctuation">)</span>
    server<span class="token punctuation">.</span>run<span class="token punctuation">(</span>WSGIHandler<span class="token punctuation">)</span>
</code></pre>
<p>WSGIRefServer 继承自 ServerAdapter，并且覆盖了 run 方法。</p>
<pre class=" language-python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">ServerAdapter</span><span class="token punctuation">(</span>object<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> host<span class="token operator">=</span><span class="token string">'127.0.0.1'</span><span class="token punctuation">,</span> port<span class="token operator">=</span><span class="token number">8080</span><span class="token punctuation">,</span> <span class="token operator">**</span>kargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>host <span class="token operator">=</span> host
        self<span class="token punctuation">.</span>port <span class="token operator">=</span> int<span class="token punctuation">(</span>port<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>options <span class="token operator">=</span> kargs

    <span class="token keyword">def</span> <span class="token function">__repr__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token string">"%s (%s:%d)"</span> <span class="token operator">%</span> <span class="token punctuation">(</span>self<span class="token punctuation">.</span>__class__<span class="token punctuation">.</span>__name__<span class="token punctuation">,</span> self<span class="token punctuation">.</span>host<span class="token punctuation">,</span> self<span class="token punctuation">.</span>port<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">run</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> handler<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">pass</span>

<span class="token keyword">class</span> <span class="token class-name">WSGIRefServer</span><span class="token punctuation">(</span>ServerAdapter<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">run</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> handler<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">from</span> wsgiref<span class="token punctuation">.</span>simple_server <span class="token keyword">import</span> make_server
        srv <span class="token operator">=</span> make_server<span class="token punctuation">(</span>self<span class="token punctuation">.</span>host<span class="token punctuation">,</span> self<span class="token punctuation">.</span>port<span class="token punctuation">,</span> handler<span class="token punctuation">)</span>
        srv<span class="token punctuation">.</span>serve_forever<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<p>这个 run 方法本身也是很简单，通过 Python 标准库中的 make_server 创建了一个 WSGI Server 然后跑了起来。</p>
<p>注意在 run 方法中的 WSGIHandler 和 WSGIRefServer.run 中的 handler 参数，这个就是如何处理一次请求和响应的关键所在。</p>
<p>在这之前，还需要先看看 Bottle 对 Request 和 Respouse 的定义。</p>
<h2 id="Request-定义"><a href="#Request-定义" class="headerlink" title="Request 定义"></a>Request 定义</h2><p>Bottle 为每次请求都会把一些参数保存在当前的线程中，通过继承 <code>threading.local</code> 实现线程安全。</p>
<pre class=" language-python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">Request</span><span class="token punctuation">(</span>threading<span class="token punctuation">.</span>local<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">pass</span> <span class="token comment" spellcheck="true"># 省略其他方法</span>
</code></pre>
<p>Request 是由一个方法和 8 个属性构成。</p>
<pre class=" language-python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">bind</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> environ<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">""" 绑定当前请求到 handler 中 """</span>
    self<span class="token punctuation">.</span>_environ <span class="token operator">=</span> environ
    self<span class="token punctuation">.</span>_GET <span class="token operator">=</span> None
    self<span class="token punctuation">.</span>_POST <span class="token operator">=</span> None
    self<span class="token punctuation">.</span>_GETPOST <span class="token operator">=</span> None
    self<span class="token punctuation">.</span>_COOKIES <span class="token operator">=</span> None
    self<span class="token punctuation">.</span>path <span class="token operator">=</span> self<span class="token punctuation">.</span>_environ<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'PATH_INFO'</span><span class="token punctuation">,</span> <span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token operator">not</span> self<span class="token punctuation">.</span>path<span class="token punctuation">.</span>startswith<span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>path <span class="token operator">=</span> <span class="token string">'/'</span> <span class="token operator">+</span> self<span class="token punctuation">.</span>path
</code></pre>
<p>bind 方法除了初始化一些变量以外，还添加 environ 到本次请求当中，environ 是一个字典包含了 CGI 的环境变量，更多 environ 内容参考<a href="https://www.python.org/dev/peps/pep-3333/#id24" target="_blank" rel="noopener">PEP-3333 中 environ Variables 部分</a>。</p>
<pre class=" language-python"><code class="language-python">@property
<span class="token keyword">def</span> <span class="token function">method</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">''' 返回请求方法 (GET,POST,PUT,DELETE 等) '''</span>
    <span class="token keyword">return</span> self<span class="token punctuation">.</span>_environ<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'REQUEST_METHOD'</span><span class="token punctuation">,</span> <span class="token string">'GET'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>upper<span class="token punctuation">(</span><span class="token punctuation">)</span>

@property
<span class="token keyword">def</span> <span class="token function">query_string</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">''' QUERY_STRING 的内容 '''</span>
    <span class="token keyword">return</span> self<span class="token punctuation">.</span>_environ<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'QUERY_STRING'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span>

@property
<span class="token keyword">def</span> <span class="token function">input_length</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">''' Content 的长度 '''</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> int<span class="token punctuation">(</span>self<span class="token punctuation">.</span>_environ<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'CONTENT_LENGTH'</span><span class="token punctuation">,</span> <span class="token string">'0'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">except</span> ValueError<span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token number">0</span>
</code></pre>
<p>这三个属性比较简单，只是从 _environ 中取出了CGI 的某个环境变量。</p>
<pre class=" language-python"><code class="language-python">@property
<span class="token keyword">def</span> <span class="token function">GET</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">""" 返回字典类型的 GET 参数 """</span>
    <span class="token keyword">if</span> self<span class="token punctuation">.</span>_GET <span class="token keyword">is</span> None<span class="token punctuation">:</span>
        raw_dict <span class="token operator">=</span> parse_qs<span class="token punctuation">(</span>self<span class="token punctuation">.</span>query_string<span class="token punctuation">,</span> keep_blank_values<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>_GET <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
        <span class="token keyword">for</span> key<span class="token punctuation">,</span> value <span class="token keyword">in</span> raw_dict<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> len<span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>_GET<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> value<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>_GET<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> value
    <span class="token keyword">return</span> self<span class="token punctuation">.</span>_GET
</code></pre>
<p>GET 属性把 query_string 解析成字典放入当前请求的变量中，所以在请求中获取 GET 方法的参数可以使用 <code>requst.GET[&#39;xxxx&#39;]</code> 这样子的用法。</p>
<pre class=" language-python"><code class="language-python">@property
<span class="token keyword">def</span> <span class="token function">POST</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""返回字典类型的 POST 参数"""</span>
    <span class="token keyword">if</span> self<span class="token punctuation">.</span>_POST <span class="token keyword">is</span> None<span class="token punctuation">:</span>
        raw_data <span class="token operator">=</span> cgi<span class="token punctuation">.</span>FieldStorage<span class="token punctuation">(</span>
            fp<span class="token operator">=</span>self<span class="token punctuation">.</span>_environ<span class="token punctuation">[</span><span class="token string">'wsgi.input'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> environ<span class="token operator">=</span>self<span class="token punctuation">.</span>_environ<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>_POST <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
        <span class="token keyword">if</span> raw_data<span class="token punctuation">:</span>
            <span class="token keyword">for</span> key <span class="token keyword">in</span> raw_data<span class="token punctuation">:</span>
                <span class="token keyword">if</span> isinstance<span class="token punctuation">(</span>raw_data<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">,</span> list<span class="token punctuation">)</span><span class="token punctuation">:</span>
                    self<span class="token punctuation">.</span>_POST<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>v<span class="token punctuation">.</span>value <span class="token keyword">for</span> v <span class="token keyword">in</span> raw_data<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">]</span>
                <span class="token keyword">elif</span> raw_data<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">.</span>filename<span class="token punctuation">:</span>
                    self<span class="token punctuation">.</span>_POST<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> raw_data<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
                <span class="token keyword">else</span><span class="token punctuation">:</span>
                    self<span class="token punctuation">.</span>_POST<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> raw_data<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">.</span>value
    <span class="token keyword">return</span> self<span class="token punctuation">.</span>_POST
</code></pre>
<p>POST 属性从 wsgi.input 中获取内容（也就是表单提交的内容）放入当前请求的变量中，可以通过 <code>request.POST[&#39;xxxx&#39;]</code> 来获取数据。</p>
<p>从 GET 和 POST 这两属性的使用来看，包括 Flask 和 Django 都实现了类似的方法，这方法属性拥有一样的步骤就是获取数据，然后转换成标准的字典格式，实现上来看没什么复杂的，就是普通的字符串处理而已。</p>
<pre class=" language-python"><code class="language-python">@property
<span class="token keyword">def</span> <span class="token function">params</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">''' 返回 GET 和 POST 的混合数据，POST 会覆盖 GET '''</span>
    <span class="token keyword">if</span> self<span class="token punctuation">.</span>_GETPOST <span class="token keyword">is</span> None<span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>_GETPOST <span class="token operator">=</span> dict<span class="token punctuation">(</span>self<span class="token punctuation">.</span>GET<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>_GETPOST<span class="token punctuation">.</span>update<span class="token punctuation">(</span>dict<span class="token punctuation">(</span>self<span class="token punctuation">.</span>POST<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> self<span class="token punctuation">.</span>_GETPOST
</code></pre>
<p>params 属性提供了一个便利访问数据的方法。</p>
<pre class=" language-python"><code class="language-python">@property
<span class="token keyword">def</span> <span class="token function">COOKIES</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Returns a dict with COOKIES."""</span>
    <span class="token keyword">if</span> self<span class="token punctuation">.</span>_COOKIES <span class="token keyword">is</span> None<span class="token punctuation">:</span>
        raw_dict <span class="token operator">=</span> Cookie<span class="token punctuation">.</span>SimpleCookie<span class="token punctuation">(</span>self<span class="token punctuation">.</span>_environ<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'HTTP_COOKIE'</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>_COOKIES <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
        <span class="token keyword">for</span> cookie <span class="token keyword">in</span> raw_dict<span class="token punctuation">.</span>values<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>_COOKIES<span class="token punctuation">[</span>cookie<span class="token punctuation">.</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> cookie<span class="token punctuation">.</span>value
     <span class="token keyword">return</span> self<span class="token punctuation">.</span>_COOKIES
</code></pre>
<p>Bottle 的 COOKIES 管理比较简单，只是单纯的从 CGI 中获取请求的 Cookie，如果存在的话直接返回。</p>
<p>以上就是 Bottle 的请求定义的内容。</p>
<p>简单总结来看，Request 从 CGI 中获取数据并且做一些数据处理，然后绑定到变量上。</p>
<h2 id="Response-定义"><a href="#Response-定义" class="headerlink" title="Response 定义"></a>Response 定义</h2><p>整体结构和 Resquest 大致一样。</p>
<pre class=" language-python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">bind</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">""" 清除旧数据并创建一个全新的响应对象 """</span>
    self<span class="token punctuation">.</span>_COOKIES <span class="token operator">=</span> None

    self<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token number">200</span>
    self<span class="token punctuation">.</span>header <span class="token operator">=</span> HeaderDict<span class="token punctuation">(</span><span class="token punctuation">)</span>
    self<span class="token punctuation">.</span>content_type <span class="token operator">=</span> <span class="token string">'text/html'</span>
    self<span class="token punctuation">.</span>error <span class="token operator">=</span> None
</code></pre>
<p>bind 方法只是初始化了一些变量。其中比较有意思的是 HeaderDict。</p>
<pre class=" language-python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">HeaderDict</span><span class="token punctuation">(</span>dict<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__setitem__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> dict<span class="token punctuation">.</span>__setitem__<span class="token punctuation">(</span>self<span class="token punctuation">,</span>key<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> value<span class="token punctuation">)</span>
    <span class="token keyword">def</span> <span class="token function">__getitem__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> dict<span class="token punctuation">.</span>__getitem__<span class="token punctuation">(</span>self<span class="token punctuation">,</span>key<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">def</span> <span class="token function">__delitem__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> dict<span class="token punctuation">.</span>__delitem__<span class="token punctuation">(</span>self<span class="token punctuation">,</span>key<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">def</span> <span class="token function">__contains__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> dict<span class="token punctuation">.</span>__contains__<span class="token punctuation">(</span>self<span class="token punctuation">,</span>key<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">items</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">""" 返回 (key, value) 形式的元组列表 """</span>
        <span class="token keyword">for</span> key<span class="token punctuation">,</span> values <span class="token keyword">in</span> dict<span class="token punctuation">.</span>items<span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> <span class="token operator">not</span> isinstance<span class="token punctuation">(</span>values<span class="token punctuation">,</span> list<span class="token punctuation">)</span><span class="token punctuation">:</span>
                values <span class="token operator">=</span> <span class="token punctuation">[</span>values<span class="token punctuation">]</span>
            <span class="token keyword">for</span> value <span class="token keyword">in</span> values<span class="token punctuation">:</span>
                <span class="token keyword">yield</span> <span class="token punctuation">(</span>key<span class="token punctuation">,</span> str<span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">add</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">""" 添加一个新 header，而不删除旧 header """</span>
        <span class="token keyword">if</span> isinstance<span class="token punctuation">(</span>value<span class="token punctuation">,</span> list<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">for</span> v <span class="token keyword">in</span> value<span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>add<span class="token punctuation">(</span>key<span class="token punctuation">,</span> v<span class="token punctuation">)</span>
        <span class="token keyword">elif</span> key <span class="token keyword">in</span> self<span class="token punctuation">:</span>
            <span class="token keyword">if</span> isinstance<span class="token punctuation">(</span>self<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">,</span> list<span class="token punctuation">)</span><span class="token punctuation">:</span>
                self<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span>value<span class="token punctuation">)</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                self<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>self<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">,</span> value<span class="token punctuation">]</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
          self<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>value<span class="token punctuation">]</span>
</code></pre>
<p>这是一个扩展于 dict 的字典，转化成大小写无关的 Title key ，还可以以列表方式添加多个成员。这个 HeaderDict 有意思的地方有两个：</p>
<ul>
<li>与大小无关的 Ttile key，也就是会吧 key 转成以大写头其他小写的 key</li>
<li>存储重复 kv 值时候 values 会以 list 形式存储。如果 values 是多层 list，会自动解析成一层数据。</li>
<li>重写 items 方法，以二元元组方式返回数据，包括多值数据。</li>
</ul>
<pre class=" language-python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> h <span class="token operator">=</span> HeaderDict<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> h<span class="token punctuation">.</span>add<span class="token punctuation">(</span><span class="token string">'mytest'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">'Test'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'test1'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'test2'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token string">'name'</span><span class="token punctuation">:</span><span class="token string">'two'</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> h
<span class="token punctuation">{</span><span class="token string">'Mytest'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'Test'</span><span class="token punctuation">,</span> <span class="token string">'test1'</span><span class="token punctuation">,</span> <span class="token string">'test2'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token string">'name'</span><span class="token punctuation">:</span> <span class="token string">'two'</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">}</span>
<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">print</span> list<span class="token punctuation">(</span>h<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token string">'Mytest'</span><span class="token punctuation">,</span> <span class="token string">'Test'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">'Mytest'</span><span class="token punctuation">,</span> <span class="token string">'test1'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">'Mytest'</span><span class="token punctuation">,</span> <span class="token string">'test2'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">'Mytest'</span><span class="token punctuation">,</span> <span class="token string">"{'name': 'two'}"</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
<span class="token operator">>></span><span class="token operator">></span>
</code></pre>
<pre class=" language-python"><code class="language-python">@property
<span class="token keyword">def</span> <span class="token function">COOKIES</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> <span class="token operator">not</span> self<span class="token punctuation">.</span>_COOKIES<span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>_COOKIES <span class="token operator">=</span> Cookie<span class="token punctuation">.</span>SimpleCookie<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> self<span class="token punctuation">.</span>_COOKIES

<span class="token keyword">def</span> <span class="token function">set_cookie</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> <span class="token operator">**</span>kargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">""" 设置 Cookie """</span>
    self<span class="token punctuation">.</span>COOKIES<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> value
    <span class="token keyword">for</span> k <span class="token keyword">in</span> kargs<span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>COOKIES<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">=</span> kargs<span class="token punctuation">[</span>k<span class="token punctuation">]</span>
</code></pre>
<p>Response 对 Cookie 的初始化，并且提供了设置的方法。</p>
<pre class=" language-python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">get_content_type</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> self<span class="token punctuation">.</span>header<span class="token punctuation">[</span><span class="token string">'Content-Type'</span><span class="token punctuation">]</span>

<span class="token keyword">def</span> <span class="token function">set_content_type</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>
    self<span class="token punctuation">.</span>header<span class="token punctuation">[</span><span class="token string">'Content-Type'</span><span class="token punctuation">]</span> <span class="token operator">=</span> value

content_type <span class="token operator">=</span> property<span class="token punctuation">(</span>
    get_content_type<span class="token punctuation">,</span>
    set_content_type<span class="token punctuation">,</span>
    None<span class="token punctuation">,</span>
    get_content_type<span class="token punctuation">.</span>__doc__<span class="token punctuation">)</span>
</code></pre>
<p>为 content_type 属性提供了 set 和 get 方法，针对的是 Header 中的  Content-Type。</p>
<h2 id="添加路由和-handler"><a href="#添加路由和-handler" class="headerlink" title="添加路由和 handler"></a>添加路由和 handler</h2><p>这部分由一个装饰器和三个方法组成。</p>
<ul>
<li>compile_route：路由正则</li>
<li>add_route：添加路由</li>
<li>route：路由装饰器</li>
</ul>
<pre class=" language-python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">route</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token operator">**</span>kargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">wrapper</span><span class="token punctuation">(</span>handler<span class="token punctuation">)</span><span class="token punctuation">:</span>
        add_route<span class="token punctuation">(</span>url<span class="token punctuation">,</span> handler<span class="token punctuation">,</span> <span class="token operator">**</span>kargs<span class="token punctuation">)</span>
        <span class="token keyword">return</span> handler
    <span class="token keyword">return</span> wrapper
</code></pre>
<p>路由装饰器，简化 add_route 的调用。</p>
<pre class=" language-python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">add_route</span><span class="token punctuation">(</span>route<span class="token punctuation">,</span> handler<span class="token punctuation">,</span> method<span class="token operator">=</span><span class="token string">'GET'</span><span class="token punctuation">,</span> simple<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    method <span class="token operator">=</span> method<span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>upper<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> re<span class="token punctuation">.</span>match<span class="token punctuation">(</span>r<span class="token string">'^/(\w+/)*\w*$'</span><span class="token punctuation">,</span> route<span class="token punctuation">)</span> <span class="token operator">or</span> simple<span class="token punctuation">:</span>
        ROUTES_SIMPLE<span class="token punctuation">.</span>setdefault<span class="token punctuation">(</span>method<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">[</span>route<span class="token punctuation">]</span> <span class="token operator">=</span> handler
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        route <span class="token operator">=</span> compile_route<span class="token punctuation">(</span>route<span class="token punctuation">)</span>
        ROUTES_REGEXP<span class="token punctuation">.</span>setdefault<span class="token punctuation">(</span>method<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">[</span>route<span class="token punctuation">,</span> handler<span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre>
<p>ROUTES_SIMPLE 和 ROUTES_REGEXP 是两个全局字典，用于存储路由相关数据（方法，参数，地址）。</p>
<p>简单路由放入 ROUTES_SIMPLE，以 method 为 key ，在 method 中再以路由地址为 key，处理函数 handler 为 value 存储。</p>
<p>复杂路由放入 ROUTES_REGEXP，以 method 为 key，以 route 和 handler 组成的元组列表存储。</p>
<h2 id="处理请求和响应"><a href="#处理请求和响应" class="headerlink" title="处理请求和响应"></a>处理请求和响应</h2><p>根据 PEP-3333 文档需要为编写一个可调用对象（可以是函数，或者是具有 __call__ 方法的类）。</p>
<p>Bottle 中的 WSGIHandler 正是这么一个可调用对象。</p>
<pre class=" language-python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">WSGIHandler</span><span class="token punctuation">(</span>environ<span class="token punctuation">,</span> start_response<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment" spellcheck="true"># 全局 request、response，每个线程独立</span>
    <span class="token keyword">global</span> request
    <span class="token keyword">global</span> response

    <span class="token comment" spellcheck="true"># bind 当前 environ 数据</span>
    request<span class="token punctuation">.</span>bind<span class="token punctuation">(</span>environ<span class="token punctuation">)</span> 
    response<span class="token punctuation">.</span>bind<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        <span class="token comment" spellcheck="true"># 根据 path 和 method 找到处理方法和参数</span>
        handler<span class="token punctuation">,</span> args <span class="token operator">=</span> match_url<span class="token punctuation">(</span>request<span class="token punctuation">.</span>path<span class="token punctuation">,</span> request<span class="token punctuation">.</span>method<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token operator">not</span> handler<span class="token punctuation">:</span>
            <span class="token keyword">raise</span> HTTPError<span class="token punctuation">(</span><span class="token number">404</span><span class="token punctuation">,</span> <span class="token string">"Not found"</span><span class="token punctuation">)</span>
        <span class="token comment" spellcheck="true"># 执行返回 output 数据</span>
        output <span class="token operator">=</span> handler<span class="token punctuation">(</span><span class="token operator">**</span>args<span class="token punctuation">)</span>
    <span class="token keyword">except</span> BreakTheBottle<span class="token punctuation">,</span> shard<span class="token punctuation">:</span>
        <span class="token comment" spellcheck="true"># Bottle 错误产生的输出</span>
        output <span class="token operator">=</span> shard<span class="token punctuation">.</span>output
    <span class="token keyword">except</span> Exception<span class="token punctuation">,</span> exception<span class="token punctuation">:</span>
        <span class="token comment" spellcheck="true"># 处理内部错误，500 错误</span>
        response<span class="token punctuation">.</span>status <span class="token operator">=</span> getattr<span class="token punctuation">(</span>exception<span class="token punctuation">,</span> <span class="token string">'http_status'</span><span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">)</span>
        errorhandler <span class="token operator">=</span> ERROR_HANDLER<span class="token punctuation">.</span>get<span class="token punctuation">(</span>response<span class="token punctuation">.</span>status<span class="token punctuation">,</span> error_default<span class="token punctuation">)</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            output <span class="token operator">=</span> errorhandler<span class="token punctuation">(</span>exception<span class="token punctuation">)</span>
        <span class="token keyword">except</span><span class="token punctuation">:</span>
            output <span class="token operator">=</span> <span class="token string">"Exception within error handler! Application stopped."</span>

        <span class="token keyword">if</span> response<span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token number">500</span><span class="token punctuation">:</span>
            request<span class="token punctuation">.</span>_environ<span class="token punctuation">[</span><span class="token string">'wsgi.errors'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string">"Error (500) on '%s': %s\n"</span> <span class="token operator">%</span> <span class="token punctuation">(</span>request<span class="token punctuation">.</span>path<span class="token punctuation">,</span> exception<span class="token punctuation">)</span><span class="token punctuation">)</span>

    db<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># DB cleanup</span>

    <span class="token comment" spellcheck="true"># 如果是文件，则发送文件</span>
    <span class="token keyword">if</span> hasattr<span class="token punctuation">(</span>output<span class="token punctuation">,</span> <span class="token string">'read'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        fileoutput <span class="token operator">=</span> output
        <span class="token keyword">if</span> <span class="token string">'wsgi.file_wrapper'</span> <span class="token keyword">in</span> environ<span class="token punctuation">:</span>
            output <span class="token operator">=</span> environ<span class="token punctuation">[</span><span class="token string">'wsgi.file_wrapper'</span><span class="token punctuation">]</span><span class="token punctuation">(</span>fileoutput<span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            output <span class="token operator">=</span> iter<span class="token punctuation">(</span><span class="token keyword">lambda</span><span class="token punctuation">:</span> fileoutput<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token number">8192</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span>
    <span class="token keyword">elif</span> isinstance<span class="token punctuation">(</span>output<span class="token punctuation">,</span> str<span class="token punctuation">)</span><span class="token punctuation">:</span>
        output <span class="token operator">=</span> <span class="token punctuation">[</span>output<span class="token punctuation">]</span>

    <span class="token comment" spellcheck="true"># 根据 response 的 cookie 添加 Set-Cookie 的 header</span>
    <span class="token keyword">for</span> c <span class="token keyword">in</span> response<span class="token punctuation">.</span>COOKIES<span class="token punctuation">.</span>values<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        response<span class="token punctuation">.</span>header<span class="token punctuation">.</span>add<span class="token punctuation">(</span><span class="token string">'Set-Cookie'</span><span class="token punctuation">,</span> c<span class="token punctuation">.</span>OutputString<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment" spellcheck="true"># 完成本次处理</span>
    status <span class="token operator">=</span> <span class="token string">'%d %s'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>response<span class="token punctuation">.</span>status<span class="token punctuation">,</span> HTTP_CODES<span class="token punctuation">[</span>response<span class="token punctuation">.</span>status<span class="token punctuation">]</span><span class="token punctuation">)</span>
    start_response<span class="token punctuation">(</span>status<span class="token punctuation">,</span> list<span class="token punctuation">(</span>response<span class="token punctuation">.</span>header<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> output
</code></pre>
<p>为了和代码契合度高，分析已经注释在当中。</p>
<p>处理流程如下：</p>
<ol>
<li>拿到线程独立的 request 和 response</li>
<li>bind environ 数据</li>
<li>根据 match_url 找到处理的 handler 和参数，执行<ol>
<li>处理 Bottle 错误</li>
<li>处理内部错误</li>
</ol>
</li>
<li>如果是文件则发送文件，不是的话正常返回字符串</li>
<li>设置 Set-Cookie header</li>
<li>结束</li>
</ol>
<h2 id="结束"><a href="#结束" class="headerlink" title="结束"></a>结束</h2><p>Bottle 0.4.10 版本的核心内容就差么多，其他都是一些错误处理之类的。</p>
<p>该版本的 Bottle 以简单的过程，描述出了一个基于 WSGI 的 Web 框架是怎么样处理请求和响应的过程，完全基于 Python 标准库实现。</p>
<p>好哒，么么哒~~~，Python 大法好啊，Python 大法好啊，Python 大法好啊。</p>
 
    </div>
    <div class="post-foot">
        <div id="disqus_thread"></div>
    </div>
</div>


                </section>
                <footer class="container fixed-690 footer">
    <div>
        <span>Power by <a href="https://hexo.io">Hexo</a></span>
    </div>
    <div>
        <span>Theme <a href="https://github.com/zhengxiaowai/hexo-theme-lessless">lessless</a></span>
    </div>
        
            
<div>
    <span id="hexiangyutest_container_site_pv">
    PV: <span id="busuanzi_value_site_pv"></span>
    </span>
    <span id="busuanzi_container_site_uv">
    UV: <span id="busuanzi_value_site_uv"></span>
    </span>
</div>

        
        
            <div>
    <span><a href="https://beian.miit.gov.cn/#/Integrated/index" target="_blank">闽ICP备17000267号-1</a></span>
</div>
        
</footer>
        </div>
        
<script src="/js/jquery-3.2.1.slim.min.js"></script>
<script src="/js/popper.min.js"></script>
<script src="/js/bootstrap.min.js"></script>


    
<script type="text/javascript">
    var disqus_config = function () {
        this.page.url = 'http://hexiangyu.me/2017/05/21/bottle-source-analysis/';
        this.page.identifier = '2017/05/21/bottle-source-analysis/';
        this.page.title = 'Bottle 源码分析';
    };
    var d = document, s = d.createElement('script');
    s.src = '//hexiangyus.disqus.com/embed.js';
    s.setAttribute('data-timestamp', '' + +new Date());
    (d.head || d.body).appendChild(s);
</script>


    </body>
</html>