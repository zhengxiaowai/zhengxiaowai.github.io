<!doctype html><html class="not-ready text-sm lg:text-base" style=--bg:#faf6f1 lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><title>CGroups 控制进程资源 - 正小歪 BLOG</title><meta name=theme-color><meta name=description content="cgroups 是 Linux 内核中的一个功能，用来限制、控制分离一个进程的资源，比如 CPU、内存、IO 等。"><meta name=author content><link rel="preload stylesheet" as=style href=http://hexiangyu.me/main.min.css><script defer src=http://hexiangyu.me/highlight.min.js onload=hljs.initHighlightingOnLoad()></script>
<link rel=preload as=image href=http://hexiangyu.me/theme.png><link rel=icon href=http://hexiangyu.me/favicon.ico><link rel=apple-touch-icon href=http://hexiangyu.me/apple-touch-icon.png><meta name=generator content="Hugo 0.107.0"><meta property="og:title" content="CGroups 控制进程资源"><meta property="og:description" content="cgroups 是 Linux 内核中的一个功能，用来限制、控制分离一个进程的资源，比如 CPU、内存、IO 等。"><meta property="og:type" content="article"><meta property="og:url" content="http://hexiangyu.me/posts/linux-cgroups-md/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2019-04-14T00:01:08+00:00"><meta property="article:modified_time" content="2019-04-14T00:01:08+00:00"><meta itemprop=name content="CGroups 控制进程资源"><meta itemprop=description content="cgroups 是 Linux 内核中的一个功能，用来限制、控制分离一个进程的资源，比如 CPU、内存、IO 等。"><meta itemprop=datePublished content="2019-04-14T00:01:08+00:00"><meta itemprop=dateModified content="2019-04-14T00:01:08+00:00"><meta itemprop=wordCount content="473"><meta itemprop=keywords content><meta name=twitter:card content="summary"><meta name=twitter:title content="CGroups 控制进程资源"><meta name=twitter:description content="cgroups 是 Linux 内核中的一个功能，用来限制、控制分离一个进程的资源，比如 CPU、内存、IO 等。"></head><body class="text-black duration-200 ease-out dark:text-white"><header class="mx-auto flex h-[5rem] max-w-3xl px-8 lg:justify-center"><div class="relative z-50 mr-auto flex items-center"><a class="-translate-x-[1px] -translate-y-0.5 text-3xl font-bold" href=http://hexiangyu.me/>正小歪 BLOG</a>
<a class="btn-dark ml-6 h-6 w-6 shrink-0 cursor-pointer [background:url(./theme.png)_left_center/_auto_theme('spacing.6')_no-repeat] [transition:_background-position_0.4s_steps(5)] dark:[background-position:right]"></a></div><a class="btn-menu relative z-50 -mr-8 flex h-[5rem] w-[5rem] shrink-0 cursor-pointer flex-col items-center justify-center gap-2.5 lg:hidden"></a>
<script>const htmlClass=document.documentElement.classList;setTimeout(()=>{htmlClass.remove("not-ready")},10);const btnMenu=document.querySelector(".btn-menu");btnMenu.addEventListener("click",()=>{htmlClass.toggle("open")});const metaTheme=document.querySelector('meta[name="theme-color"]'),lightBg=`"#faf6f1"`.replace(/"/g,""),setDark=e=>{metaTheme.setAttribute("content",e?"#000":lightBg),htmlClass[e?"add":"remove"]("dark"),localStorage.setItem("dark",e)},darkScheme=window.matchMedia("(prefers-color-scheme: dark)"),darkVal=localStorage.getItem("dark");setDark(darkVal?darkVal==="true":darkScheme.matches),darkScheme.addEventListener("change",e=>{setDark(e.matches)});const btnDark=document.querySelector(".btn-dark");btnDark.addEventListener("click",()=>{setDark(localStorage.getItem("dark")!=="true")})</script><div class="nav-wrapper fixed inset-x-0 top-full z-40 flex h-full select-none flex-col justify-center pb-16 duration-200 dark:bg-black lg:static lg:h-auto lg:flex-row lg:!bg-transparent lg:pb-0 lg:transition-none"></div></header><main class="prose prose-neutral relative mx-auto min-h-[calc(100%-10rem)] max-w-3xl px-8 pt-20 pb-32 dark:prose-invert"><article><header class=mb-20><h1 class="!my-0 pb-2.5">CGroups 控制进程资源</h1><div class="text-sm opacity-60"><time>Apr 14, 2019</time></div></header><section><p>cgroups 是 Linux 内核中的一个功能，用来限制、控制分离一个进程的资源，比如 CPU、内存、IO 等。</p><p>cgroups 是由一组子系统构成，每种子系统即时一种资源，目前可使用的资源如下：</p><ul><li>cpu：限制 cpu 的使用率</li><li>cpuacct：cpu 的统计报告</li><li>cpuset：分配 cpu</li><li>memory：分配 mem 的使用量</li><li>blkio：限制块设备的 io</li><li>devices：能够访问的设备</li><li>net_cls：控制网络数据的访问</li><li>net_prio：网络流量包的优先级</li><li>freezer：pause 或者 resume 进程</li><li>ns：控制 namespace 的访问</li></ul><p>cgroups 中有个 hierarchy 的概念，意思一组 cgroup 是一棵树，cgroup2 可以挂在 cgroup 1 上，这样可以从 cgroup1 中继承设置。</p><p>所以 process、subsystem、hierarchy 存在一些关系。</p><ol><li>一个 subsystem 只能附加到一个 hierarchy</li><li>一个 hierarchy 可以附加到多个 subsystem 中</li><li>一个 process 可以作为多个 cgroups 成员，但是要在不同的 hierarchy 中</li><li>fork 出的子进程默认和父进程使用一个 cgroups，但是可以移动到其他的 cgroups 中</li></ol><p>在 linux 中 /sys/fs/cgroup 中是 cgroups 默认的 hierarchy，可以看到目前的 subsystem</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>dr-xr-xr-x <span style=color:#ae81ff>6</span> root root  <span style=color:#ae81ff>0</span> Dec <span style=color:#ae81ff>17</span> 17:31 blkio
</span></span><span style=display:flex><span>lrwxrwxrwx <span style=color:#ae81ff>1</span> root root <span style=color:#ae81ff>11</span> Dec <span style=color:#ae81ff>17</span> 17:31 cpu -&gt; cpu,cpuacct
</span></span><span style=display:flex><span>dr-xr-xr-x <span style=color:#ae81ff>6</span> root root  <span style=color:#ae81ff>0</span> Dec <span style=color:#ae81ff>17</span> 17:31 cpu,cpuacct
</span></span><span style=display:flex><span>lrwxrwxrwx <span style=color:#ae81ff>1</span> root root <span style=color:#ae81ff>11</span> Dec <span style=color:#ae81ff>17</span> 17:31 cpuacct -&gt; cpu,cpuacct
</span></span><span style=display:flex><span>dr-xr-xr-x <span style=color:#ae81ff>4</span> root root  <span style=color:#ae81ff>0</span> Dec <span style=color:#ae81ff>17</span> 17:31 cpuset
</span></span><span style=display:flex><span>dr-xr-xr-x <span style=color:#ae81ff>6</span> root root  <span style=color:#ae81ff>0</span> Dec <span style=color:#ae81ff>17</span> 17:31 devices
</span></span><span style=display:flex><span>dr-xr-xr-x <span style=color:#ae81ff>4</span> root root  <span style=color:#ae81ff>0</span> Dec <span style=color:#ae81ff>17</span> 17:31 freezer
</span></span><span style=display:flex><span>dr-xr-xr-x <span style=color:#ae81ff>7</span> root root  <span style=color:#ae81ff>0</span> Dec <span style=color:#ae81ff>17</span> 17:31 memory
</span></span><span style=display:flex><span>lrwxrwxrwx <span style=color:#ae81ff>1</span> root root <span style=color:#ae81ff>16</span> Dec <span style=color:#ae81ff>17</span> 17:31 net_cls -&gt; net_cls,net_prio
</span></span><span style=display:flex><span>dr-xr-xr-x <span style=color:#ae81ff>3</span> root root  <span style=color:#ae81ff>0</span> Dec <span style=color:#ae81ff>17</span> 17:31 net_cls,net_prio
</span></span><span style=display:flex><span>lrwxrwxrwx <span style=color:#ae81ff>1</span> root root <span style=color:#ae81ff>16</span> Dec <span style=color:#ae81ff>17</span> 17:31 net_prio -&gt; net_cls,net_prio
</span></span><span style=display:flex><span>dr-xr-xr-x <span style=color:#ae81ff>3</span> root root  <span style=color:#ae81ff>0</span> Dec <span style=color:#ae81ff>17</span> 17:31 perf_event
</span></span><span style=display:flex><span>dr-xr-xr-x <span style=color:#ae81ff>3</span> root root  <span style=color:#ae81ff>0</span> Dec <span style=color:#ae81ff>17</span> 17:31 pids
</span></span><span style=display:flex><span>dr-xr-xr-x <span style=color:#ae81ff>5</span> root root  <span style=color:#ae81ff>0</span> Dec <span style=color:#ae81ff>17</span> 17:31 systemd
</span></span></code></pre></div><p>假如我们想给一个进程添加内存限制，第一步需要创建一个 hierarchy 在 /sys/fs/cgroup/memory 中</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>sudo mkdir /sys/fs/cgroup/memory/mytestcgroup
</span></span></code></pre></div><p>系统会帮助我们创建一系列文件，这是因为我们挂载的类型是 cgroup，cgroup 的 hierarchy 目录会被映射成文件目录，方便操作：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>-rw-r--r-- <span style=color:#ae81ff>1</span> root root <span style=color:#ae81ff>0</span> Apr <span style=color:#ae81ff>14</span> 21:36 cgroup.clone_children
</span></span><span style=display:flex><span>--w--w--w- <span style=color:#ae81ff>1</span> root root <span style=color:#ae81ff>0</span> Apr <span style=color:#ae81ff>14</span> 21:36 cgroup.event_control
</span></span><span style=display:flex><span>-rw-r--r-- <span style=color:#ae81ff>1</span> root root <span style=color:#ae81ff>0</span> Apr <span style=color:#ae81ff>14</span> 21:36 cgroup.procs
</span></span><span style=display:flex><span>-rw-r--r-- <span style=color:#ae81ff>1</span> root root <span style=color:#ae81ff>0</span> Apr <span style=color:#ae81ff>14</span> 21:36 memory.failcnt
</span></span><span style=display:flex><span>--w------- <span style=color:#ae81ff>1</span> root root <span style=color:#ae81ff>0</span> Apr <span style=color:#ae81ff>14</span> 21:36 memory.force_empty
</span></span><span style=display:flex><span>-rw-r--r-- <span style=color:#ae81ff>1</span> root root <span style=color:#ae81ff>0</span> Apr <span style=color:#ae81ff>14</span> 21:36 memory.limit_in_bytes
</span></span><span style=display:flex><span>-rw-r--r-- <span style=color:#ae81ff>1</span> root root <span style=color:#ae81ff>0</span> Apr <span style=color:#ae81ff>14</span> 21:36 memory.max_usage_in_bytes
</span></span><span style=display:flex><span>-rw-r--r-- <span style=color:#ae81ff>1</span> root root <span style=color:#ae81ff>0</span> Apr <span style=color:#ae81ff>14</span> 21:36 memory.memsw.failcnt
</span></span><span style=display:flex><span>-rw-r--r-- <span style=color:#ae81ff>1</span> root root <span style=color:#ae81ff>0</span> Apr <span style=color:#ae81ff>14</span> 21:36 memory.memsw.limit_in_bytes
</span></span><span style=display:flex><span>-rw-r--r-- <span style=color:#ae81ff>1</span> root root <span style=color:#ae81ff>0</span> Apr <span style=color:#ae81ff>14</span> 21:36 memory.memsw.max_usage_in_bytes
</span></span><span style=display:flex><span>-r--r--r-- <span style=color:#ae81ff>1</span> root root <span style=color:#ae81ff>0</span> Apr <span style=color:#ae81ff>14</span> 21:36 memory.memsw.usage_in_bytes
</span></span><span style=display:flex><span>-rw-r--r-- <span style=color:#ae81ff>1</span> root root <span style=color:#ae81ff>0</span> Apr <span style=color:#ae81ff>14</span> 21:36 memory.move_charge_at_immigrate
</span></span><span style=display:flex><span>-r--r--r-- <span style=color:#ae81ff>1</span> root root <span style=color:#ae81ff>0</span> Apr <span style=color:#ae81ff>14</span> 21:36 memory.numa_stat
</span></span><span style=display:flex><span>-rw-r--r-- <span style=color:#ae81ff>1</span> root root <span style=color:#ae81ff>0</span> Apr <span style=color:#ae81ff>14</span> 21:36 memory.oom_control
</span></span><span style=display:flex><span>---------- <span style=color:#ae81ff>1</span> root root <span style=color:#ae81ff>0</span> Apr <span style=color:#ae81ff>14</span> 21:36 memory.pressure_level
</span></span><span style=display:flex><span>-rw-r--r-- <span style=color:#ae81ff>1</span> root root <span style=color:#ae81ff>0</span> Apr <span style=color:#ae81ff>14</span> 21:36 memory.soft_limit_in_bytes
</span></span><span style=display:flex><span>-r--r--r-- <span style=color:#ae81ff>1</span> root root <span style=color:#ae81ff>0</span> Apr <span style=color:#ae81ff>14</span> 21:36 memory.stat
</span></span><span style=display:flex><span>-rw-r--r-- <span style=color:#ae81ff>1</span> root root <span style=color:#ae81ff>0</span> Apr <span style=color:#ae81ff>14</span> 21:36 memory.swappiness
</span></span><span style=display:flex><span>-r--r--r-- <span style=color:#ae81ff>1</span> root root <span style=color:#ae81ff>0</span> Apr <span style=color:#ae81ff>14</span> 21:36 memory.usage_in_bytes
</span></span><span style=display:flex><span>-rw-r--r-- <span style=color:#ae81ff>1</span> root root <span style=color:#ae81ff>0</span> Apr <span style=color:#ae81ff>14</span> 21:36 memory.use_hierarchy
</span></span><span style=display:flex><span>-rw-r--r-- <span style=color:#ae81ff>1</span> root root <span style=color:#ae81ff>0</span> Apr <span style=color:#ae81ff>14</span> 21:36 notify_on_release
</span></span><span style=display:flex><span>-rw-r--r-- <span style=color:#ae81ff>1</span> root root <span style=color:#ae81ff>0</span> Apr <span style=color:#ae81ff>14</span> 21:36 tasks
</span></span></code></pre></div><p>在上面的文件中我们可以看到 tasks，这里面放着就是被限制的进程 pid，我们把当前 session 的 pid 放入 task 中，以后从这个 session 启动的进程将会被限制，比如限制一下内存只能使用 100m。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>sudo bash -c <span style=color:#e6db74>&#34;echo &#34;</span>100m<span style=color:#e6db74>&#34; &gt; memory.limit_in_bytes&#34;</span>
</span></span><span style=display:flex><span>sudo bash -c <span style=color:#e6db74>&#34;echo </span>$$<span style=color:#e6db74> &gt; tasks&#34;</span>
</span></span></code></pre></div><p>然后使用 stress 工具启动一个测压</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>stress --vm-bytes 200m --vm-keep -m <span style=color:#ae81ff>1</span>
</span></span></code></pre></div><p>最后通过 top 等工具可以发现内存被限制到了 100m。</p><h2 id=go-语言控制-cgroup>Go 语言控制 cgroup</h2><p>Go 语言中并没有特殊的 API 接口来处理 cgroup，依然是通过和命令行一样的模式（读写文件）来控制 cgroup。</p><p>所以，在 go 语言中就是创建文件夹，删除文件加，写入文件这三个操作来使用 cgroup 功能。</p></section><nav class="mt-24 flex rounded-lg bg-black/[3%] text-lg dark:bg-white/[8%]"><a class="flex w-1/2 items-center p-6 pr-3 no-underline" href=http://hexiangyu.me/posts/go-enums-md/><span class=mr-1.5>←</span><span>「译」在 Golang 中实现枚举类型</span></a>
<a class="ml-auto flex w-1/2 items-center justify-end p-6 pl-3 no-underline" href=http://hexiangyu.me/posts/golang-beachmark-details/><span>「译」更详细的 Go 性能测试</span><span class=ml-1.5>→</span></a></nav></article></main><footer class="opaco mx-auto flex h-[5rem] max-w-3xl items-center px-8 text-[0.9em] opacity-60"><div class=mr-auto>&copy; 2022
<a class=link href=http://hexiangyu.me/>正小歪 BLOG</a></div><a class="link mx-6" href=https://gohugo.io/ rel=noopener target=_blank>Powered by Hugo️️</a>️
<a class=link href=https://github.com/nanxiaobei/hugo-paper rel=noopener target=_blank>▷ Paper 6</a></footer></body></html>